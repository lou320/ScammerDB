{% extends 'scammers/base.html' %}
{% load i18n %}

{% block content %}
<style>
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loader {
        border: 16px solid #f3f3f3;
        border-top: 16px solid #3498db;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .phone-form .input-group select {
        flex: 0 0 35% !important; 
    }
</style>

<div id="loading-overlay">
    <div class="loader"></div>
</div>

<h2 class="{% if request.LANGUAGE_CODE == 'my' %}burmese-heading{% endif %}">{% trans "Add Scammer Details" %}</h2>
<p>{% trans "Click the + icon at lower corner of the screen to add scammer details." %}</p>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Default Fields -->
    <div id="name-formset">
        {{ name_formset.management_form }}
        {% for form in name_formset %}
            <div class="formset-row name-form mb-2">
                {{ form.id }}
                <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                <div class="input-group">
                    {{ form.name }}
                    <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="mb-3 mt-3">
        <input type="text" name="tags" class="form-control" placeholder="{% trans "Add tags" %}" id="id_tags" value="{{ form.tags.value|default:'' }}">
    </div>

    <!-- Containers for dynamically added fields -->
    <div id="phone-formset">
        {{ phone_formset.management_form }}
        {% for form in phone_formset %}
            <div class="formset-row phone-form mb-2">
                {{ form.id }}
                <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                <div class="input-group">
                    {{ form.phone_number.0 }} <!-- Country Code Select -->
                    {{ form.phone_number.1 }} <!-- Phone Number Input -->
                    <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        {% endfor %}
    </div>
    <div id="email-formset">
        {{ email_formset.management_form }}
        {% for form in email_formset %}{% if form.instance.pk %}
            <div class="formset-row email-form mb-2">
                {{ form.id }}
                <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                <div class="input-group">
                    {{ form.email }}
                    <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        {% endif %}{% endfor %}
    </div>
    <div id="website-formset">
        {{ website_formset.management_form }}
        {% for form in website_formset %}{% if form.instance.pk %}
            <div class="formset-row website-form mb-2">
                {{ form.id }}
                <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                <div class="input-group">
                    {{ form.website }}
                    <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        {% endif %}{% endfor %}
    </div>
    <div id="image-formset">
        {{ image_formset.management_form }}
        {% for form in image_formset %}{% if form.instance.pk %}
            <div class="formset-row image-form mb-2">
                {{ form.id }}
                <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                <div class="input-group">
                    {{ form.image }}
                    <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        {% endif %}{% endfor %}
    </div>

    <div id="payment-account-formset">
        {{ payment_account_formset.management_form }}
        {% for form in payment_account_formset %}{% if form.instance.pk %}
            <div class="formset-row payment-account-form mb-2">
                {{ form.id }}
                <div class="delete-checkbox" style="display:none;">{{ form.DELETE }}</div>
                <div class="input-group">
                    {{ form.account_number }}
                    <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        {% endif %}{% endfor %}
    </div>



    <div class="mb-3 mt-3">
        {{ form.description }}
    </div>

    <hr>
    <button type="submit" class="btn btn-danger">{% trans "Save Scammer" %}</button>
    <a href="{% url 'scammer_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
</form>


<!-- Floating Action Button -->
<div class="fab-container">
    <div class="fab-menu" id="fab-menu">
        <div class="fab-menu-item" data-form-type="name">
            <span class="fab-label">{% trans "Name" %}</span>
            <button type="button" class="btn btn-info btn-sm"><i class="fas fa-user-plus"></i></button>
        </div>
        <div class="fab-menu-item" data-form-type="phone">
            <span class="fab-label">{% trans "Phone Number" %}</span>
            <button type="button" class="btn btn-info btn-sm"><i class="fas fa-phone"></i></button>
        </div>
        <div class="fab-menu-item" data-form-type="email">
            <span class="fab-label">{% trans "Email" %}</span>
            <button type="button" class="btn btn-info btn-sm"><i class="fas fa-envelope"></i></button>
        </div>
        <div class="fab-menu-item" data-form-type="website">
            <span class="fab-label">{% trans "Website" %}</span>
            <button type="button" class="btn btn-info btn-sm"><i class="fas fa-globe"></i></button>
        </div>
        <div class="fab-menu-item" data-form-type="image">
            <span class="fab-label">{% trans "Image" %}</span>
            <button type="button" class="btn btn-info btn-sm"><i class="fas fa-image"></i></button>
        </div>
        <div class="fab-menu-item" data-form-type="payment_account">
            <span class="fab-label">{% trans "Payment Account" %}</span>
            <button type="button" class="btn btn-info btn-sm"><i class="fas fa-money-check-alt"></i></button>
        </div>

    </div>
    <button type="button" class="btn btn-danger rounded-circle fab" id="fab-toggle">
        <i class="fas fa-plus"></i>
    </button>
</div>


<!-- Empty Forms (for cloning) -->
<div id="empty-name-form" style="display: none;">
    <div class="formset-row name-form mb-2">
        {{ name_formset.empty_form.id }}
        <div class="delete-checkbox" style="display:none;">{{ name_formset.empty_form.DELETE }}</div>
        <div class="input-group">
            {{ name_formset.empty_form.name }}
            <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</div>
<div id="empty-phone-form" style="display: none;">
    <div class="formset-row phone-form mb-2">
        {{ phone_formset.empty_form.id }}
        <div class="delete-checkbox" style="display:none;">{{ phone_formset.empty_form.DELETE }}</div>
        <div class="input-group">
            {{ phone_formset.empty_form.phone_number.0 }}
            {{ phone_formset.empty_form.phone_number.1 }}
            <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</div>
<div id="empty-email-form" style="display: none;">
    <div class="formset-row email-form mb-2">
        {{ email_formset.empty_form.id }}
        <div class="delete-checkbox" style="display:none;">{{ email_formset.empty_form.DELETE }}</div>
        <div class="input-group">
            {{ email_formset.empty_form.email }}
            <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</div>
<div id="empty-website-form" style="display: none;">
    <div class="formset-row website-form mb-2">
        {{ website_formset.empty_form.id }}
        <div class="delete-checkbox" style="display:none;">{{ website_formset.empty_form.DELETE }}</div>
        <div class="input-group">
            {{ website_formset.empty_form.website }}
            <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</div>
<div id="empty-image-form" style="display: none;">
    <div class="formset-row image-form mb-2">
        {{ image_formset.empty_form.id }}
        <div class="delete-checkbox" style="display:none;">{{ image_formset.empty_form.DELETE }}</div>
        <div class="input-group">
            {{ image_formset.empty_form.image }}
            <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</div>
<div id="empty-payment-account-form" style="display: none;">
    <div class="formset-row payment-account-form mb-2">
        {{ payment_account_formset.empty_form.id }}
        <div class="delete-checkbox" style="display:none;">{{ payment_account_formset.empty_form.DELETE }}</div>
        <div class="input-group">
            {{ payment_account_formset.empty_form.account_number }}
            <button class="btn btn-outline-danger remove-form-row" type="button"><i class="fas fa-trash"></i></button>
        </div>
    </div>


{{ all_tags|json_script:"tags-whitelist" }}
{% endblock %}

{% block extra_js %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- Get shared elements ---
    const form = document.querySelector('form');
    const loadingOverlay = document.getElementById('loading-overlay');
    const fabToggle = document.getElementById('fab-toggle');
    const fabMenu = document.getElementById('fab-menu');
    const submitButton = document.querySelector('button[type="submit"]');

    // --- Compressor Logic ---
    // (This now lives inside your main DOMContentLoaded)
    document.body.addEventListener('change', (event) => {
        const input = event.target;
        if (input.type === 'file' && input.name.endsWith('-image')) {
            const file = input.files[0];
            if (!file) { return; }

            console.log('Original file selected:', { name: file.name, size: (file.size/1024/1024).toFixed(2) + ' MB' });

            new Compressor(file, {
                quality: 0.6,     
                maxWidth: 1280,   
                maxHeight: 1280,
                mimeType: 'image/jpeg', 
                success(compressedResult) {
                    console.log('Compression SUCCESS:', { name: compressedResult.name, size: (compressedResult.size/1024/1024).toFixed(2) + ' MB' });
                    const compressedFile = new File([compressedResult], compressedResult.name, {
                        type: compressedResult.type,
                        lastModified: Date.now(),
                    });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(compressedFile);
                    input.files = dataTransfer.files;
                },
                error(err) {
                    console.error('Compression FAILED:', err.message);
                },
            });
        }
    });

    // --- LOADING SPINNER FIX (with Validation Check) ---
    if (form && loadingOverlay && submitButton) {
        console.log('Loading spinner script initialized.');

        submitButton.addEventListener('click', function(event) {
            console.log('Submit button clicked.');
            // 1. Stop the form immediately
            event.preventDefault();

            // 2. CHECK HTML5 VALIDITY FIRST!
            if (!form.checkValidity()) {
                console.log('Form is invalid. Aborting submission.');
                // Form is invalid (e.g., required field is empty)
                // Tell the browser to show the validation error (e.g., "Please fill out this field.")
                // We do NOT show the spinner.
                form.reportValidity();
                return; // Stop here
            }

            console.log('Form is valid. Showing loading spinner.');
            // 3. If valid, show the spinner
            loadingOverlay.style.display = 'flex';

            // 4. Use requestAnimationFrame to ensure the spinner is painted before submission
            requestAnimationFrame(() => {
                console.log('requestAnimationFrame callback executed.');
                // A nested timeout to give it a moment longer, just in case.
                setTimeout(() => {
                    console.log('Submitting form now.');
                    form.submit();
                }, 0);
            });
        });
    } else {
        console.error('Could not find form, loadingOverlay, or submitButton element.');
    }

    // --- FAB Logic ---
    if (fabToggle && fabMenu) {
        fabToggle.addEventListener('click', function() {
            fabMenu.style.display = fabMenu.style.display === 'flex' ? 'none' : 'flex';
        });
    }

    // --- Dynamic Formset Logic ---
    const formsetMap = {
        name: { container: 'name-formset', empty: 'empty-name-form', prefix: 'names' },
        phone: { container: 'phone-formset', empty: 'empty-phone-form', prefix: 'phones' },
        email: { container: 'email-formset', empty: 'empty-email-form', prefix: 'emails' },
        website: { container: 'website-formset', empty: 'empty-website-form', prefix: 'websites' },
        image: { container: 'image-formset', empty: 'empty-image-form', prefix: 'images' },
        payment_account: { container: 'payment-account-formset', empty: 'empty-payment-account-form', prefix: 'payment_accounts' }
    };

    if (fabMenu) {
        fabMenu.addEventListener('click', function(e) {
            const menuItem = e.target.closest('.fab-menu-item');
            if (!menuItem) return;

            const formType = menuItem.dataset.formType;
            const config = formsetMap[formType];
            if (!config) return;

            const formsetContainer = document.getElementById(config.container);
            const totalFormsInput = document.querySelector(`#id_${config.prefix}-TOTAL_FORMS`);
            let formIdx = parseInt(totalFormsInput.value);

            const emptyFormTemplate = document.getElementById(config.empty).innerHTML;
            const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formIdx);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml;
            const newFormElement = tempDiv.firstElementChild;
            
            formsetContainer.appendChild(newFormElement);
            totalFormsInput.value = formIdx + 1;
            
            fabMenu.style.display = 'none';

            if (formType === 'phone') {
                const newFormRow = newFormElement;
                const countryCodeSelect = newFormRow.querySelector('select[name$="-phone_number_0"]');
                const localNumberInput = newFormRow.querySelector('input[name$="-phone_number_1"]');
                
                if (countryCodeSelect) {
                    countryCodeSelect.addEventListener('change', () => formatPhoneNumber(newFormRow));
                }
                if (localNumberInput) {
                    localNumberInput.addEventListener('input', () => formatPhoneNumber(newFormRow));
                }
            }
        });
    }

    // --- Remove Row Logic ---
    document.body.addEventListener('click', function(e) {
        let removeBtn = e.target.closest('.remove-form-row');
        if (removeBtn) {
            const formRow = removeBtn.closest('.formset-row');
            const deleteInput = formRow.querySelector('input[type="checkbox"]');
            if (deleteInput) {
                deleteInput.checked = true;
            }
            formRow.style.display = 'none';
        }
    });

    // --- Phone Number Formatting Logic ---
    function formatPhoneNumber(formRow) {
        const countryCodeSelect = formRow.querySelector('select[name$="-phone_number_0"]');
        const localNumberInput = formRow.querySelector('input[name$="-phone_number_1"]');
        if (!countryCodeSelect || !localNumberInput) return;
        let localNumber = localNumberInput.value.replace(/\D/g, ''); 
        if (localNumber.startsWith('0')) {
            localNumber = localNumber.substring(1);
        }
        localNumberInput.value = localNumber; 
    }

    document.querySelectorAll('.phone-form').forEach(formRow => {
        const countryCodeSelect = formRow.querySelector('select[name$="-phone_number_0"]');
        const localNumberInput = formRow.querySelector('input[name$="-phone_number_1"]');
        
        if (countryCodeSelect) {
            countryCodeSelect.addEventListener('change', () => formatPhoneNumber(formRow));
        }
        if (localNumberInput) {
            localNumberInput.addEventListener('input', () => formatPhoneNumber(formRow));
        }
    });

    // --- Tagify Init ---
    var input = document.getElementById('id_tags');
    var whitelistEl = document.getElementById('tags-whitelist');
    var whitelist = [];
    if (whitelistEl) {
        whitelist = JSON.parse(whitelistEl.textContent);
    }
    var tagify = new Tagify(input, {
        whitelist: whitelist,
        enforceWhitelist: false,
        dropdown: {
            enabled: 0,
            maxItems: 20,
            position: "all",
            closeOnSelect: false,
            highlightFirst: true
        }
    });

    // --- DIAGNOSTIC SCRIPT for Tagify background issue ---
    function forceTagBackground(tagEl) {
        if (!tagEl) return;
        var innerDiv = tagEl.querySelector('div');
        if (innerDiv) {
            innerDiv.style.setProperty('background', 'transparent', 'important');
        }
    }

    tagify.on('add', function(e) {
        forceTagBackground(e.detail.tag);
    });

    // Also check existing tags on page load
    tagify.getTagElms().forEach(forceTagBackground);
});
</script>
{% endblock %}